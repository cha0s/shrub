<!DOCTYPE html><html lang="en"><head><title>packages/shrub-limiter/limiter</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="packages/shrub-limiter/limiter"><meta name="groc-project-path" content="packages/shrub-limiter/limiter.coffee"><meta name="groc-github-url" content="https://github.com/cha0s/shrub"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/cha0s/shrub/blob/master/packages/shrub-limiter/limiter.coffee">packages/shrub-limiter/limiter.coffee</a></div></div><div id="document"><div class="segment"></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="limits">Limits</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">Promise = </span><span class="kc">null</span>

<span class="nv">orm = </span><span class="kc">null</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="limiter">Limiter</h2>

<p>Provides methods to tally scores, and compare them against a threshold of
time.</p>

<p>The <a href="./packages/limiter/index.html">limiter</a> package implements hook
<code>endpointAlter</code> to allow RPC endpoints to limit consumers to a specified
number of requests per time period. For instance, by default the
<a href="./packages/user/login.html">user login</a> endpoint limits the number of logins
a user may attempt to 3 every 30 seconds.
<code>TODO</code>: Rewrite this comment</p></div></div><div class="code"><div class="wrapper"><span class="nv">module.exports = </span><span class="k">class</span> <span class="nx">Limiter</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="threshold">threshold</h2>

<p>Expose a factory method for constructing Threshold instances. A
Threshold is defined like:</p>

<pre><code>{Limiter} = require 'shrub-limiter'
Limiter.threshold(4).every(20).minutes()
</code></pre>

<p>Which means that the threshold represents the allowance of a score of 4
to accumulate over the period of 20 minutes. If more score is accrued
during that window, then the threshold is said to be crossed.</p></div></div><div class="code"><div class="wrapper">  <span class="vi">@threshold: </span><span class="nf">(score) -&gt;</span> <span class="k">new</span> <span class="nx">ThresholdBase</span> <span class="nx">score</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="constructor"><em>constructor</em></h3>

<p><em>Create a limiter.</em></p>

<ul>
<li><p>(string) <code>key</code> - A unique key for this limiter,
e.g. "rpc://user.login:limiter"</p></li>
<li><p>(Threshold) <code>threshold</code> - A threshold, see below for details.</p></li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nv">constructor: </span><span class="nf">(key, @threshold, @excluded = []) -&gt;</span>

    <span class="c1"># Make sure it&#39;s a threshold.</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span>
      <span class="s">&quot;Limiter(</span><span class="si">#{</span><span class="nx">key</span><span class="si">}</span><span class="s">) must be constructed with a valid threshold!&quot;</span>
    <span class="p">)</span> <span class="k">unless</span> <span class="nx">@threshold</span> <span class="k">instanceof</span> <span class="nx">ThresholdFinal</span>

    <span class="nx">Promise</span> <span class="o">?=</span> <span class="nx">require</span> <span class="s">&#39;bluebird&#39;</span>

    <span class="nx">orm</span> <span class="o">?=</span> <span class="nx">require</span> <span class="s">&#39;shrub-orm&#39;</span>

    <span class="c1"># Create the low-level limiter.</span>
    <span class="vi">@limiter = </span><span class="k">new</span> <span class="nx">LimiterManager</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">@threshold</span><span class="p">.</span><span class="nx">calculateSeconds</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="add">.add</h3>

<p><em>Accrue score for a limiter.</em></p>

<ul>
<li><p>(array) <code>keys</code> - An array of keys, e.g. a flattened array of keys
from <a href="./audit.html"><code>audit.fingerprint()</code></a></p></li>
<li><p>(integer) <code>score</code> - The score to add. Defaults to 1.</p></li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nv">accrue: </span><span class="nf">(keys, score = 1) -&gt;</span>
    <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span> <span class="p">(</span><span class="nx">@limiter</span><span class="p">.</span><span class="nx">accrue</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">score</span> <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">keys</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="accrueandcheckthreshold">.accrueAndCheckThreshold</h3>

<p><em>Add score to a limiter, and check it against the threshold.</em></p>

<ul>
<li><p>(array) <code>keys</code> - An array of keys, e.g. a flattened array of keys
from <a href="./audit.html"><code>audit.fingerprint()</code></a></p></li>
<li><p>(integer) <code>score</code> - The score to add. Defaults to 1.</p></li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nv">accrueAndCheckThreshold: </span><span class="nf">(keys, score = 1) -&gt;</span>
    <span class="nx">@accrue</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">score</span><span class="p">).</span><span class="nx">then</span> <span class="o">=&gt;</span> <span class="nx">@checkThreshold</span> <span class="nx">keys</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="score">.score</h3>

<p><em>Check score for a limiter.</em></p>

<ul>
<li>(array) <code>keys</code> - An array of keys, e.g. a flattened array of keys
from <a href="./audit.html"><code>audit.fingerprint()</code></a></li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nv">score: </span><span class="nf">(keys) -&gt;</span> <span class="nx">@_largest</span> <span class="nx">keys</span><span class="p">,</span> <span class="s">&#39;score&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="ttl">.ttl</h3>

<p><em>Time-to-live for a limiter.</em></p>

<ul>
<li>(array) <code>keys</code> - An array of keys, e.g. a flattened array of keys
from <a href="./audit.html"><code>audit.fingerprint()</code></a></li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nv">ttl: </span><span class="nf">(keys) -&gt;</span> <span class="nx">@_largest</span> <span class="nx">keys</span><span class="p">,</span> <span class="s">&#39;ttl&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="checkthreshold">.checkThreshold</h3>

<p><em>Check the current limiter score against the threshold.</em></p>

<ul>
<li>(array) <code>keys</code> - An array of keys, e.g. a flattened array of keys
from <a href="./audit.html"><code>audit.fingerprint()</code></a></li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nv">checkThreshold: </span><span class="nf">(keys) -&gt;</span>
    <span class="nx">@score</span><span class="p">(</span><span class="nx">keys</span><span class="p">).</span><span class="nx">then</span> <span class="nf">(score) =&gt;</span> <span class="nx">score</span> <span class="o">&gt;</span> <span class="nx">@threshold</span><span class="p">.</span><span class="nx">score</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="-largest">._largest</h4>

<p>(internal) <em>Find the largest result from a group of results.</em></p></div></div><div class="code"><div class="wrapper">  <span class="nv">_largest: </span><span class="nf">(keys, index) -&gt;</span>
    <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span>
      <span class="nx">@limiter</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="nx">key</span> <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">keys</span>

    <span class="p">).</span><span class="nx">then</span> <span class="nf">(reduction) -&gt;</span>
      <span class="nx">reduction</span><span class="p">.</span><span class="nx">reduce</span> <span class="p">(</span><span class="nf">(l, r) -&gt;</span> <span class="k">if</span> <span class="nx">l</span> <span class="o">&gt;</span> <span class="nx">r</span> <span class="k">then</span> <span class="nx">l</span> <span class="k">else</span> <span class="nx">r</span><span class="p">),</span> <span class="o">-</span><span class="kc">Infinity</span>

<span class="k">class</span> <span class="nx">LimiterManager</span>

  <span class="nv">constructor: </span><span class="nf">(@key, @threshold) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="add">.add</h3>

<p><em>Add score to a limiter.</em></p>

<ul>
<li><p>(string) <code>id</code> - The ID of the limiter.</p></li>
<li><p>(integer) <code>score</code> - The score to add. Defaults to 1.</p></li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nv">accrue: </span><span class="nf">(id, score = 1) -&gt;</span>
    <span class="nv">key = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">@key</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">id</span><span class="si">}</span><span class="s">&quot;</span>

    <span class="nv">Limit = </span><span class="nx">orm</span><span class="p">.</span><span class="nx">collection</span> <span class="s">&#39;shrub-limit&#39;</span>
    <span class="nx">Limit</span><span class="p">.</span><span class="nx">findOrCreate</span><span class="p">(</span>
      <span class="nv">key: </span><span class="nx">key</span>
    <span class="p">,</span>
      <span class="nv">key: </span><span class="nx">key</span>
    <span class="p">).</span><span class="nx">populateAll</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nf">(limit) =&gt;</span>

      <span class="c1"># Reset if it&#39;s expired.</span>
      <span class="nx">limit</span><span class="p">.</span><span class="nx">reset</span><span class="p">()</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&gt;=</span> <span class="nx">limit</span><span class="p">.</span><span class="nx">ttl</span> <span class="nx">@threshold</span>

      <span class="k">return</span> <span class="nx">limit</span>

    <span class="p">).</span><span class="nx">then</span> <span class="nf">(limit) -&gt;</span> <span class="nx">limit</span><span class="p">.</span><span class="nx">accrue</span><span class="p">(</span><span class="nb">parseInt</span> <span class="nx">score</span><span class="p">).</span><span class="nx">save</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="score">.score</h3>

<p><em>Check score for a limiter.</em></p>

<ul>
<li>(string) <code>id</code> - The ID of the limiter.</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nv">score: </span><span class="nf">(id) -&gt;</span>

    <span class="c1"># Get all scores for this limiter.</span>
    <span class="nv">Limit = </span><span class="nx">orm</span><span class="p">.</span><span class="nx">collection</span> <span class="s">&#39;shrub-limit&#39;</span>
    <span class="nx">Limit</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nv">key: </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">@key</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">id</span><span class="si">}</span><span class="s">&quot;</span><span class="p">).</span><span class="nx">populateAll</span><span class="p">().</span><span class="nx">then</span> <span class="nf">(limit) =&gt;</span>
      <span class="k">return</span> <span class="mi">0</span> <span class="k">unless</span> <span class="nx">limit</span><span class="o">?</span>
      <span class="k">return</span> <span class="nx">limit</span><span class="p">.</span><span class="nx">score</span><span class="p">()</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="nx">limit</span><span class="p">.</span><span class="nx">ttl</span> <span class="nx">@threshold</span>

      <span class="c1"># Reset if it&#39;s expired.</span>
      <span class="nx">limit</span><span class="p">.</span><span class="nx">reset</span><span class="p">().</span><span class="nx">save</span><span class="p">().</span><span class="nx">then</span> <span class="nf">-&gt;</span> <span class="mi">0</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="ttl">.ttl</h3>

<p><em>Time-to-live for a limiter.</em></p>

<ul>
<li>(string) <code>id</code> - The ID of the limiter.</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nv">ttl: </span><span class="nf">(id) -&gt;</span>

    <span class="nv">Limit = </span><span class="nx">orm</span><span class="p">.</span><span class="nx">collection</span> <span class="s">&#39;shrub-limit&#39;</span>
    <span class="nx">Limit</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nv">key: </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">@key</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">id</span><span class="si">}</span><span class="s">&quot;</span><span class="p">).</span><span class="nx">then</span> <span class="nf">(limit) =&gt;</span>
      <span class="k">return</span> <span class="mi">0</span> <span class="k">unless</span> <span class="nx">limit</span><span class="o">?</span>
      <span class="k">return</span> <span class="nx">ttl</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="nv">ttl = </span><span class="nx">limit</span><span class="p">.</span><span class="nx">ttl</span> <span class="nx">@threshold</span>

      <span class="c1"># Reset if it&#39;s expired.</span>
      <span class="nx">limit</span><span class="p">.</span><span class="nx">reset</span><span class="p">().</span><span class="nx">save</span><span class="p">().</span><span class="nx">then</span> <span class="nf">-&gt;</span> <span class="mi">0</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="thresholdbase">ThresholdBase</h2>

<p>The base class used to define a threshold.</p></div></div><div class="code"><div class="wrapper"><span class="k">class</span> <span class="nx">ThresholdBase</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="constructor"><em>constructor</em></h3>

<p><em>Create a threshold base object.</em></p>

<ul>
<li>(integer) <code>score</code> - The maximum score allowed to accrue.</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nv">constructor: </span><span class="nf">(@_score) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="every">.every</h3>

<p><em>Define the quantity of time this threshold concerns.</em></p>

<ul>
<li>(integer) <code>amount</code> - The quantity of time units this threshold
concerns. e.g, if the threshold is every 5 minutes, this will be <code>5</code>.</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nv">every: </span><span class="nf">(amount) -&gt;</span> <span class="k">new</span> <span class="nx">ThresholdMultiplier</span> <span class="nx">@_score</span><span class="p">,</span> <span class="nx">amount</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="thresholdmultiplier">ThresholdMultiplier</h2>

<p>A threshold class to collect the multiplier.</p></div></div><div class="code"><div class="wrapper"><span class="k">class</span> <span class="nx">ThresholdMultiplier</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="constructor"><em>constructor</em></h3>

<p><em>Create a threshold.</em></p>

<ul>
<li><p>(integer) <code>score</code> - Passed along from ThresholdBase.</p></li>
<li><p>(integer) <code>amount</code> - Passed along from ThresholdBase.</p></li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nv">constructor: </span><span class="nf">(@_score, @_amount) -&gt;</span>

    <span class="vi">@_multiplier = </span><span class="mi">1</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add a method for each multipler. This is this way just to DRY things up.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">multipliers =</span>
    <span class="nv">milliseconds: </span><span class="mi">1</span> <span class="o">/</span> <span class="mi">1000</span>
    <span class="nv">seconds: </span><span class="mi">1</span>
    <span class="nv">minutes: </span><span class="mi">60</span>

  <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">multiplier</span> <span class="k">of</span> <span class="nx">multipliers</span>
    <span class="nx">do</span> <span class="nf">(key, multiplier) -&gt;</span>
      <span class="nx">ThresholdMultiplier</span><span class="o">::</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nf">-&gt;</span>
        <span class="vi">@_multiplier = </span><span class="nx">multiplier</span>

        <span class="c1"># Return a finalized threshold.</span>
        <span class="k">new</span> <span class="nx">ThresholdFinal</span> <span class="nx">@_score</span><span class="p">,</span> <span class="nx">@_amount</span><span class="p">,</span> <span class="nx">@_multiplier</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="thresholdfinal">ThresholdFinal</h2>

<p>A finalized threshold definition.</p></div></div><div class="code"><div class="wrapper"><span class="k">class</span> <span class="nx">ThresholdFinal</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="constructor"><em>constructor</em></h3>

<p><em>Create a threshold.</em></p>

<ul>
<li><p>(integer) <code>score</code> - Passed along from ThresholdMultiplier.</p></li>
<li><p>(integer) <code>amount</code> - Passed along from ThresholdMultiplier.</p></li>
<li><p>(integer) <code>multiplier</code> - Passed along from ThresholdMultiplier.</p></li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nv">constructor: </span><span class="nf">(score, amount, multiplier) -&gt;</span>

    <span class="vi">@calculateSeconds = </span><span class="nf">-&gt;</span> <span class="nx">amount</span> <span class="o">*</span> <span class="nx">multiplier</span>
    <span class="vi">@score = </span><span class="nf">-&gt;</span> <span class="nx">score</span></div></div></div></div></body></html>