<!DOCTYPE html><html lang="en"><head><title>packages/shrub-user/client/index</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="packages/shrub-user/client/index"><meta name="groc-project-path" content="packages/shrub-user/client/index.coffee"><meta name="groc-github-url" content="https://github.com/cha0s/shrub"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/cha0s/shrub/blob/master/packages/shrub-user/client/index.coffee">packages/shrub-user/client/index.coffee</a></div></div><div id="document"><div class="segment"></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="user">User</h1>

<p>User operations, model, etc.</p></div></div><div class="code"><div class="wrapper"><span class="nv">exports.pkgmanRegister = </span><span class="nf">(registrar) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="implementshookcollections">Implements hook <code>collections</code></h2></div></div><div class="code"><div class="wrapper">  <span class="nx">registrar</span><span class="p">.</span><span class="nx">registerHook</span> <span class="s">&#39;collections&#39;</span><span class="p">,</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">collections</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="implementshookcollectionsalter">Implements hook <code>collectionsAlter</code></h2></div></div><div class="code"><div class="wrapper">  <span class="nx">registrar</span><span class="p">.</span><span class="nx">registerHook</span> <span class="s">&#39;collectionsAlter&#39;</span><span class="p">,</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">collectionsAlter</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="implementshookservice">Implements hook <code>service</code></h2></div></div><div class="code"><div class="wrapper">  <span class="nx">registrar</span><span class="p">.</span><span class="nx">registerHook</span> <span class="s">&#39;service&#39;</span><span class="p">,</span> <span class="nf">-&gt;</span> <span class="p">[</span>
    <span class="s">&#39;shrub-orm&#39;</span><span class="p">,</span> <span class="s">&#39;shrub-rpc&#39;</span><span class="p">,</span> <span class="s">&#39;shrub-socket&#39;</span>
    <span class="nf">(orm, rpc, socket) -&gt;</span>

      <span class="nv">config = </span><span class="nx">require</span> <span class="s">&#39;config&#39;</span>

      <span class="nv">User = </span><span class="nx">orm</span><span class="p">.</span><span class="nx">collection</span> <span class="s">&#39;shrub-user&#39;</span>

      <span class="nv">service = </span><span class="p">{}</span>

      <span class="nv">_instance = </span><span class="p">{}</span>
      <span class="nx">_instance</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">User</span><span class="p">.</span><span class="nx">instantiate</span><span class="p">(</span>
        <span class="nx">config</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;packageConfig:shrub-user&#39;</span>
      <span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log a user out if we get a socket call.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">logout = </span><span class="nf">-&gt;</span>

        <span class="nv">blank = </span><span class="nx">User</span><span class="p">.</span><span class="nx">instantiate</span><span class="p">()</span>
        <span class="k">delete</span> <span class="nx">_instance</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">of</span> <span class="nx">_instance</span>
        <span class="nx">_instance</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">blank</span>

        <span class="k">return</span>

      <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;shrub.user.logout&#39;</span><span class="p">,</span> <span class="nx">logout</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="userisloggedin">user.isLoggedIn</h2>

<p><em>Whether the current application user is logged in.</em></p></div></div><div class="code"><div class="wrapper">      <span class="nv">service.isLoggedIn = </span><span class="nf">-&gt;</span> <span class="nx">_instance</span><span class="p">.</span><span class="nx">id</span><span class="o">?</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="userlogin">user.login</h2>

<p><em>Log in with method and args.</em></p>

<p><code>TODO</code>: username and password are tightly coupled to local
strategy. Change that.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">service.login = </span><span class="nf">(method, username, password) -&gt;</span>

        <span class="nx">rpc</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span>
          <span class="s">&#39;shrub.user.login&#39;</span>
          <span class="nv">method: </span><span class="nx">method</span>
          <span class="nv">username: </span><span class="nx">username</span>
          <span class="nv">password: </span><span class="nx">password</span>

        <span class="p">).</span><span class="nx">then</span> <span class="nf">(O) -&gt;</span>
          <span class="nx">_instance</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">O</span>
          <span class="k">return</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="userlogout">user.logout</h2>

<p><em>Log out.</em></p></div></div><div class="code"><div class="wrapper">      <span class="nv">service.logout = </span><span class="nf">-&gt;</span>

        <span class="nx">rpc</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span>
          <span class="s">&#39;shrub.user.logout&#39;</span>

        <span class="p">).</span><span class="nx">then</span> <span class="nx">logout</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="userinstance">user.instance</h2>

<p><em>Retrieve the user instance.</em></p></div></div><div class="code"><div class="wrapper">      <span class="nv">service.instance = </span><span class="nf">-&gt;</span> <span class="nx">_instance</span>

      <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;packageConfig:shrub-core:testMode&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="userfakelogin">user.fakeLogin</h2>

<p><em>Mock a login process.</em></p>

<p><code>TODO</code>: This will change when login method generalization
happens.</p></div></div><div class="code"><div class="wrapper">        <span class="nv">service.fakeLogin = </span><span class="nf">(username, password, id) -&gt;</span>
          <span class="nx">password</span> <span class="o">?=</span> <span class="s">&#39;password&#39;</span>
          <span class="nx">id</span> <span class="o">?=</span> <span class="mi">1</span>

          <span class="nx">socket</span><span class="p">.</span><span class="nx">catchEmit</span> <span class="s">&#39;rpc://shrub.user.login&#39;</span><span class="p">,</span> <span class="nf">(data, fn) -&gt;</span>
            <span class="nx">fn</span> <span class="nv">result: id: </span><span class="nx">id</span><span class="p">,</span> <span class="nv">name: </span><span class="nx">username</span>

          <span class="nx">service</span><span class="p">.</span><span class="nx">login</span> <span class="s">&#39;local&#39;</span><span class="p">,</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">password</span>

      <span class="nx">service</span>

  <span class="p">]</span>

  <span class="nx">registrar</span><span class="p">.</span><span class="nx">recur</span> <span class="p">[</span>
    <span class="s">&#39;email&#39;</span><span class="p">,</span> <span class="s">&#39;forgot&#39;</span><span class="p">,</span> <span class="s">&#39;login&#39;</span><span class="p">,</span> <span class="s">&#39;logout&#39;</span><span class="p">,</span> <span class="s">&#39;register&#39;</span><span class="p">,</span> <span class="s">&#39;reset&#39;</span>
  <span class="p">]</span>

<span class="nv">exports.collections = </span><span class="nf">-&gt;</span>

  <span class="nv">Group =</span>

    <span class="nv">attributes:</span>

      <span class="nv">name:</span>
        <span class="nv">type: </span><span class="s">&#39;string&#39;</span>
        <span class="nv">size: </span><span class="mi">24</span>
        <span class="nv">maxLength: </span><span class="mi">24</span>

      <span class="nv">permissions:</span>
        <span class="nv">collection: </span><span class="s">&#39;shrub-group-permission&#39;</span>
        <span class="nv">via: </span><span class="s">&#39;group&#39;</span>

  <span class="nv">GroupPermission =</span>

    <span class="nv">attributes:</span>

      <span class="nv">permission: </span><span class="s">&#39;string&#39;</span>

      <span class="nv">group: model: </span><span class="s">&#39;shrub-group&#39;</span>

  <span class="nv">User =</span>

    <span class="nv">attributes:</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Last time this user was accessed.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">lastAccessed:</span>
        <span class="nv">type: </span><span class="s">&#39;datetime&#39;</span>
        <span class="nv">defaultsTo: </span><span class="nf">-&gt;</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Email address.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">email:</span>
        <span class="nv">type: </span><span class="s">&#39;string&#39;</span>
        <span class="nv">index: </span><span class="kc">true</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Name.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">name:</span>
        <span class="nv">type: </span><span class="s">&#39;string&#39;</span>
        <span class="nv">defaultsTo: </span><span class="s">&#39;Anonymous&#39;</span>
        <span class="nv">size: </span><span class="mi">24</span>
        <span class="nv">maxLength: </span><span class="mi">24</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Groups this user belongs to.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">groups:</span>
        <span class="nv">collection: </span><span class="s">&#39;shrub-user-group&#39;</span>
        <span class="nv">via: </span><span class="s">&#39;user&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Groups this user belongs to.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">permissions:</span>
        <span class="nv">collection: </span><span class="s">&#39;shrub-user-permission&#39;</span>
        <span class="nv">via: </span><span class="s">&#39;user&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check whether a user has a permission.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">hasPermission: </span><span class="nf">(permission) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Superuser?</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">@id</span> <span class="o">is</span> <span class="mi">1</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check group permissions.</p></div></div><div class="code"><div class="wrapper">        <span class="k">for</span> <span class="p">{</span><span class="nx">permissions</span><span class="p">}</span> <span class="k">in</span> <span class="nx">@groups</span>
          <span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="o">~</span><span class="nx">permissions</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">permission</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check inline permissions.</p></div></div><div class="code"><div class="wrapper">        <span class="k">return</span> <span class="o">~</span><span class="nx">@permissions</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">permission</span>

  <span class="nv">UserGroup =</span>

    <span class="nv">attributes:</span>

      <span class="nv">group: model: </span><span class="s">&#39;shrub-group&#39;</span>

      <span class="nv">user: model: </span><span class="s">&#39;shrub-user&#39;</span>

  <span class="nv">UserPermission =</span>

    <span class="nv">attributes:</span>

      <span class="nv">permission: </span><span class="s">&#39;string&#39;</span>

      <span class="nv">user: model: </span><span class="s">&#39;shrub-user&#39;</span>

  <span class="s">&#39;shrub-group&#39;</span><span class="o">:</span> <span class="nx">Group</span>
  <span class="s">&#39;shrub-group-permission&#39;</span><span class="o">:</span> <span class="nx">GroupPermission</span>
  <span class="s">&#39;shrub-user&#39;</span><span class="o">:</span> <span class="nx">User</span>
  <span class="s">&#39;shrub-user-group&#39;</span><span class="o">:</span> <span class="nx">UserGroup</span>
  <span class="s">&#39;shrub-user-permission&#39;</span><span class="o">:</span> <span class="nx">UserPermission</span>

<span class="nv">exports.collectionsAlter = </span><span class="nf">(collections) -&gt;</span>

  <span class="nv">Promise = </span><span class="nx">require</span> <span class="s">&#39;bluebird&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>TODO</code>: This is broken since ORM change</p></div></div><div class="code"><div class="wrapper">  <span class="p">{</span><span class="s">&#39;shrub-user&#39;</span><span class="o">:</span> <span class="nx">User</span><span class="p">}</span> <span class="o">=</span> <span class="nx">collections</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Implement all the built-in collection methods as authenticated versions,
which take a user.</p></div></div><div class="code"><div class="wrapper">  <span class="k">for</span> <span class="nx">identity</span><span class="p">,</span> <span class="nx">collection</span> <span class="k">of</span> <span class="nx">collections</span>
    <span class="nx">do</span> <span class="nf">(identity, collection) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>validateUser = (user) -></p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>new Promise (resolve, reject) -&gt;
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>    # `TODO`: See if we can do this without using the internal
    # _model property.
    return resolve()# if user instanceof User._model
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>    error = new Error "Invalid user."
    error.code = 500
    reject error
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>checkPermission = (user, perm) -></p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>return if user.hasPermission perm
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>error = new Error "Forbidden."
error.code = 403
throw error
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="secure-by-default">Secure by default.</h1>

<p>collection.attributes.isAccessibleBy ?= (user) -> false</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>collection.authenticatedAll = (user, params) -></p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>validateUser(user).then(-&gt;
    checkPermission user, "shrub-orm:#{name}:all"
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>).then(-&gt;
    orm.collection(identity).all params
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>).then (models) -&gt;
    return models if models.length &gt; 0
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>    error = new Error "Collection not found."
    error.code = 404
    Promise.reject error
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>collection.authenticatedCount = (user) -></p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>validateUser(user).then(-&gt;
    checkPermission user, "shrub-orm:#{name}:count"
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>).then -&gt; orm.collection(identity).count()
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>collection.authenticatedCreate = (user, attributes) -></p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>validateUser(user).then(-&gt;
    checkPermission user, "shrub-orm:#{name}:create"
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>).then -&gt; orm.collection(identity).create attributes
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>collection.authenticatedDestroy = (user, id) -></p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>validateUser(user).then(-&gt;
    checkPermission user, "shrub-orm:#{name}:create"
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>).then(-&gt;
    collection.authenticatedFind user, id
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>).then (model) -&gt;
    return model.destroy() if model.isDeletableBy user
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>    if model.isAccessibleBy user
        error = new Error "Access denied."
        error.code = 403
    else
        error = new Error "Resource not found."
        error.code = 404
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>    Promise.reject error
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>collection.authenticatedDestroyAll = (user) -></p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>validateUser(user).then(-&gt;
    checkPermission "shrub-orm:#{name}:destroyAll"
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>).then -&gt; orm.collection(identity).destroyAll()
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>collection.authenticatedFind = (user, id) -></p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>validateUser(user).then(-&gt;
    orm.collection(identity).find id
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>).then (model) -&gt;
    return model if model? and model.isAccessibleBy user
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>    error = new Error "Resource not found."
    error.code = 404
    Promise.reject error
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>collection.authenticatedUpdate = (user, id, attributes) -></p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>validateUser(user).then(-&gt;
    collection.authenticatedFind user, id
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>).then (model) -&gt;
    if model.isEditableBy user
        for k, v of attributes
            model[k] = v
        model.id = id
        return model.save()
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>    if model.isAccessibleBy user
        error = new Error "Access denied."
        error.code = 403
    else
        error = new Error "Resource not found."
        error.code = 404
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>    Promise.reject error
</code></pre></div></div><div class="code"><div class="wrapper">      <span class="nx">collection</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">isAccessibleBy</span> <span class="o">?=</span> <span class="nf">(user) -&gt;</span> <span class="kc">false</span>
      <span class="nx">collection</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">isEditableBy</span> <span class="o">?=</span> <span class="nf">(user) -&gt;</span> <span class="kc">false</span>
      <span class="nx">collection</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">isDeletableBy</span> <span class="o">?=</span> <span class="nf">(user) -&gt;</span> <span class="kc">false</span>

  <span class="k">return</span></div></div></div></div></body></html>