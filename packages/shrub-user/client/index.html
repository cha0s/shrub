<!DOCTYPE html><html lang="en"><head><title>packages/shrub-user/client/index</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="packages/shrub-user/client/index"><meta name="groc-project-path" content="packages/shrub-user/client/index.coffee"><meta name="groc-github-url" content="https://github.com/cha0s/shrub"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/cha0s/shrub/blob/master/packages/shrub-user/client/index.coffee">packages/shrub-user/client/index.coffee</a></div></div><div id="document"><div class="segment"></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="user">User</h1>

<p>User operations, model, etc.</p></div></div><div class="code"><div class="wrapper"><span class="nv">Promise = </span><span class="nx">require</span> <span class="s">&#39;bluebird&#39;</span>

<span class="nv">config = </span><span class="nx">require</span> <span class="s">&#39;config&#39;</span>

<span class="nv">exports.pkgmanRegister = </span><span class="nf">(registrar) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="implementshookcollections">Implements hook <code>collections</code></h2></div></div><div class="code"><div class="wrapper">  <span class="nx">registrar</span><span class="p">.</span><span class="nx">registerHook</span> <span class="s">&#39;collections&#39;</span><span class="p">,</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">collections</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="implementshookcollectionsalter">Implements hook <code>collectionsAlter</code></h2></div></div><div class="code"><div class="wrapper">  <span class="nx">registrar</span><span class="p">.</span><span class="nx">registerHook</span> <span class="s">&#39;collectionsAlter&#39;</span><span class="p">,</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">collectionsAlter</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="implementshookservice">Implements hook <code>service</code></h2></div></div><div class="code"><div class="wrapper">  <span class="nx">registrar</span><span class="p">.</span><span class="nx">registerHook</span> <span class="s">&#39;service&#39;</span><span class="p">,</span> <span class="nf">-&gt;</span> <span class="p">[</span>
    <span class="s">&#39;shrub-orm&#39;</span><span class="p">,</span> <span class="s">&#39;shrub-rpc&#39;</span><span class="p">,</span> <span class="s">&#39;shrub-socket&#39;</span>
    <span class="nf">(orm, rpc, socket) -&gt;</span>
      
      <span class="nv">service = </span><span class="p">{}</span>
      
      <span class="nv">_instance = </span><span class="p">{}</span>
      
      <span class="nv">_instance = name: </span><span class="s">&#39;loading...&#39;</span>
      
      <span class="nx">orm</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s">&#39;shrub-user&#39;</span><span class="p">).</span><span class="nx">then</span> <span class="nf">(User) -&gt;</span>
        <span class="nx">_instance</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">User</span><span class="p">.</span><span class="nx">instantiate</span><span class="p">(</span>
          <span class="nx">config</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;packageConfig:shrub-user&#39;</span>
        <span class="p">)</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Log a user out if we get a socket call.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">logout = </span><span class="nf">-&gt;</span>
      
        <span class="nx">orm</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s">&#39;shrub-user&#39;</span><span class="p">).</span><span class="nx">then</span> <span class="nf">(User) -&gt;</span>
          <span class="nv">blank = </span><span class="nx">User</span><span class="p">.</span><span class="nx">instantiate</span><span class="p">()</span>
          <span class="k">delete</span> <span class="nx">_instance</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">of</span> <span class="nx">_instance</span>
          <span class="k">delete</span> <span class="nx">_instance</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">blank</span>
        
        <span class="k">return</span>
      
      <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;shrub.user.logout&#39;</span><span class="p">,</span> <span class="nx">logout</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="userisloggedin">user.isLoggedIn</h2>

<p><em>Whether the current application user is logged in.</em></p></div></div><div class="code"><div class="wrapper">      <span class="nv">service.isLoggedIn = </span><span class="nf">-&gt;</span> <span class="nx">_instance</span><span class="p">.</span><span class="nx">id</span><span class="o">?</span> 
        </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="userlogin">user.login</h2>

<p><em>Log in with method and args.</em></p>

<p><code>TODO</code>: username and password are tightly coupled to local
strategy. Change that.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">service.login = </span><span class="nf">(method, username, password) -&gt;</span>
        
        <span class="nx">rpc</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span>
          <span class="s">&#39;shrub.user.login&#39;</span>
          <span class="nv">method: </span><span class="nx">method</span>
          <span class="nv">username: </span><span class="nx">username</span>
          <span class="nv">password: </span><span class="nx">password</span>
        
        <span class="p">).</span><span class="nx">then</span> <span class="nf">(O) -&gt;</span> <span class="nx">orm</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s">&#39;shrub-user&#39;</span><span class="p">).</span><span class="nx">then</span> <span class="nf">(User) -&gt;</span>
          <span class="nx">_instance</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">O</span>
          <span class="k">return</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="userlogout">user.logout</h2>

<p><em>Log out.</em></p></div></div><div class="code"><div class="wrapper">      <span class="nv">service.logout = </span><span class="nf">-&gt;</span>
        
        <span class="nx">rpc</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span>
          <span class="s">&#39;shrub.user.logout&#39;</span>
  
        <span class="p">).</span><span class="nx">then</span> <span class="nx">logout</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="userinstance">user.instance</h2>

<p><em>Retrieve the user instance.</em></p></div></div><div class="code"><div class="wrapper">      <span class="nv">service.instance = </span><span class="nf">-&gt;</span> <span class="nx">_instance</span>
      
      <span class="nx">service</span>
      
  <span class="p">]</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="implementshookservicemock">Implements hook <code>serviceMock</code></h2></div></div><div class="code"><div class="wrapper">  <span class="nx">registrar</span><span class="p">.</span><span class="nx">registerHook</span> <span class="s">&#39;serviceMock&#39;</span><span class="p">,</span> <span class="nf">-&gt;</span> <span class="p">[</span>
    <span class="s">&#39;$delegate&#39;</span><span class="p">,</span> <span class="s">&#39;shrub-socket&#39;</span>
    <span class="nf">($delegate, socket) -&gt;</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="userfakelogin">user.fakeLogin</h2>

<p><em>Mock a login process.</em></p>

<p><code>TODO</code>: This will change when login method generalization happens.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">$delegate.fakeLogin = </span><span class="nf">(username, password = &#39;password&#39;, id = 1) -&gt;</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">catchEmit</span> <span class="s">&#39;rpc://shrub.user.login&#39;</span><span class="p">,</span> <span class="nf">(data, fn) -&gt;</span>
          <span class="nx">fn</span> <span class="nv">result: id: </span><span class="nx">id</span><span class="p">,</span> <span class="nv">name: </span><span class="nx">username</span>
          
        <span class="nx">$delegate</span><span class="p">.</span><span class="nx">login</span> <span class="s">&#39;local&#39;</span><span class="p">,</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">password</span>
        
      <span class="nx">$delegate</span>
    
  <span class="p">]</span>
  
  <span class="nx">registrar</span><span class="p">.</span><span class="nx">recur</span> <span class="p">[</span>
    <span class="s">&#39;email&#39;</span><span class="p">,</span> <span class="s">&#39;forgot&#39;</span><span class="p">,</span> <span class="s">&#39;login&#39;</span><span class="p">,</span> <span class="s">&#39;logout&#39;</span><span class="p">,</span> <span class="s">&#39;register&#39;</span><span class="p">,</span> <span class="s">&#39;reset&#39;</span>
  <span class="p">]</span>
  
<span class="nv">exports.collections = </span><span class="nf">-&gt;</span>

  <span class="k">return</span> <span class="s">&#39;shrub-user&#39;</span><span class="o">:</span>
  
    <span class="nv">attributes:</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Last time this user was accessed.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">lastAccessed:</span>
        <span class="nv">type: </span><span class="s">&#39;datetime&#39;</span>
        <span class="nv">defaultsTo: </span><span class="nf">-&gt;</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Email address.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">email:</span>
        <span class="nv">type: </span><span class="s">&#39;string&#39;</span>
        <span class="nv">index: </span><span class="kc">true</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Case-insensitivized name.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">iname:</span>
        <span class="nv">type: </span><span class="s">&#39;string&#39;</span>
        <span class="nv">size: </span><span class="mi">24</span>
        <span class="nv">index: </span><span class="kc">true</span>
        </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Name.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">name:</span>
        <span class="nv">type: </span><span class="s">&#39;string&#39;</span>
        <span class="nv">defaultsTo: </span><span class="s">&#39;Anonymous&#39;</span>
        <span class="nv">size: </span><span class="mi">24</span>
        <span class="nv">maxLength: </span><span class="mi">24</span>
        </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Hash of the plaintext password.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">passwordHash:</span>
        <span class="nv">type: </span><span class="s">&#39;string&#39;</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A token which can be used to reset the user's password (once).</p></div></div><div class="code"><div class="wrapper">      <span class="nv">resetPasswordToken:</span>
        <span class="nv">type: </span><span class="s">&#39;string&#39;</span>
        <span class="nv">size: </span><span class="mi">48</span>
        <span class="nv">index: </span><span class="kc">true</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>A 512-bit salt used to cryptographically hash the user's password.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">salt:</span>
        <span class="nv">type: </span><span class="s">&#39;string&#39;</span>
        <span class="nv">size: </span><span class="mi">128</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Update a user's last accessed time. Return the user for chaining.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">touch: </span><span class="nf">-&gt;</span>
        <span class="vi">@lastAccessed = </span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">toISOString</span><span class="p">()</span>
        <span class="k">this</span>
          </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>TODO</code>: Access control structure.</p></div></div><div class="code"><div class="wrapper">      <span class="nv">hasPermission: </span><span class="nf">(perm) -&gt;</span> <span class="kc">false</span>
    
<span class="nv">exports.collectionsAlter = </span><span class="nf">(collections) -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>TODO</code>: This is broken since ORM change</p></div></div><div class="code"><div class="wrapper">  <span class="p">{</span><span class="s">&#39;shrub-user&#39;</span><span class="o">:</span> <span class="nx">User</span><span class="p">}</span> <span class="o">=</span> <span class="nx">collections</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Implement all the built-in collection methods as authenticated versions,
which take a user.</p></div></div><div class="code"><div class="wrapper">  <span class="k">for</span> <span class="nx">identity</span><span class="p">,</span> <span class="nx">collection</span> <span class="k">of</span> <span class="nx">collections</span>
    <span class="nx">do</span> <span class="nf">(identity, collection) -&gt;</span>
  
      <span class="nv">validateUser = </span><span class="nf">(user) -&gt;</span>
        
        <span class="k">new</span> <span class="nx">Promise</span> <span class="nf">(resolve, reject) -&gt;</span>
        </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><code>TODO</code>: See if we can do this without using the internal
_model property.</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">resolve</span><span class="p">()</span><span class="c1"># if user instanceof User._model</span>
            
          <span class="nv">error = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Invalid user.&quot;</span>
          <span class="nv">error.code = </span><span class="mi">500</span>
          <span class="nx">reject</span> <span class="nx">error</span>
      
      <span class="nv">checkPermission = </span><span class="nf">(user, perm) -&gt;</span>
      
        <span class="k">return</span> <span class="k">if</span> <span class="nx">user</span><span class="p">.</span><span class="nx">hasPermission</span> <span class="nx">perm</span>
          
        <span class="nv">error = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Forbidden.&quot;</span>
        <span class="nv">error.code = </span><span class="mi">403</span>
        <span class="k">throw</span> <span class="nx">error</span>
          </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Secure by default.</p></div></div><div class="code"><div class="wrapper">      <span class="nx">collection</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">isAccessibleBy</span> <span class="o">?=</span> <span class="nf">(user) -&gt;</span> <span class="kc">false</span>

      <span class="nv">collection.authenticatedAll = </span><span class="nf">(user, params) -&gt;</span>
        
        <span class="nx">validateUser</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nf">-&gt;</span>
          <span class="nx">checkPermission</span> <span class="nx">user</span><span class="p">,</span> <span class="s">&quot;shrub-orm:</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">:all&quot;</span>
        
        <span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nf">-&gt;</span>
          <span class="nx">orm</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="nx">identity</span><span class="p">).</span><span class="nx">all</span> <span class="nx">params</span>
        
        <span class="p">).</span><span class="nx">then</span> <span class="nf">(models) -&gt;</span>
          <span class="k">return</span> <span class="nx">models</span> <span class="k">if</span> <span class="nx">models</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
          
          <span class="nv">error = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Collection not found.&quot;</span>
          <span class="nv">error.code = </span><span class="mi">404</span>
          <span class="nx">Promise</span><span class="p">.</span><span class="nx">reject</span> <span class="nx">error</span>
      
      <span class="nv">collection.authenticatedCount = </span><span class="nf">(user) -&gt;</span>
        
        <span class="nx">validateUser</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nf">-&gt;</span>
          <span class="nx">checkPermission</span> <span class="nx">user</span><span class="p">,</span> <span class="s">&quot;shrub-orm:</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">:count&quot;</span>
        
        <span class="p">).</span><span class="nx">then</span> <span class="nf">-&gt;</span> <span class="nx">orm</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="nx">identity</span><span class="p">).</span><span class="nx">count</span><span class="p">()</span>
        
      <span class="nv">collection.authenticatedCreate = </span><span class="nf">(user, attributes) -&gt;</span>
    
        <span class="nx">validateUser</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nf">-&gt;</span>
          <span class="nx">checkPermission</span> <span class="nx">user</span><span class="p">,</span> <span class="s">&quot;shrub-orm:</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">:create&quot;</span>
        
        <span class="p">).</span><span class="nx">then</span> <span class="nf">-&gt;</span> <span class="nx">orm</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="nx">identity</span><span class="p">).</span><span class="nx">create</span> <span class="nx">attributes</span>
    
      <span class="nv">collection.authenticatedDestroy = </span><span class="nf">(user, id) -&gt;</span>
      
        <span class="nx">validateUser</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nf">-&gt;</span>
          <span class="nx">checkPermission</span> <span class="nx">user</span><span class="p">,</span> <span class="s">&quot;shrub-orm:</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">:create&quot;</span>
        
        <span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nf">-&gt;</span>
          <span class="nx">collection</span><span class="p">.</span><span class="nx">authenticatedFind</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">id</span>
        
        <span class="p">).</span><span class="nx">then</span> <span class="nf">(model) -&gt;</span>
          <span class="k">return</span> <span class="nx">model</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span> <span class="k">if</span> <span class="nx">model</span><span class="p">.</span><span class="nx">isDeletableBy</span> <span class="nx">user</span>
            
          <span class="k">if</span> <span class="nx">model</span><span class="p">.</span><span class="nx">isAccessibleBy</span> <span class="nx">user</span>
            <span class="nv">error = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Access denied.&quot;</span>
            <span class="nv">error.code = </span><span class="mi">403</span>
          <span class="k">else</span>
            <span class="nv">error = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Resource not found.&quot;</span>
            <span class="nv">error.code = </span><span class="mi">404</span>
          
          <span class="nx">Promise</span><span class="p">.</span><span class="nx">reject</span> <span class="nx">error</span>
      
      <span class="nv">collection.authenticatedDestroyAll = </span><span class="nf">(user) -&gt;</span>
      
        <span class="nx">validateUser</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nf">-&gt;</span>
          <span class="nx">checkPermission</span> <span class="s">&quot;shrub-orm:</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">:destroyAll&quot;</span>
        
        <span class="p">).</span><span class="nx">then</span> <span class="nf">-&gt;</span> <span class="nx">orm</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="nx">identity</span><span class="p">).</span><span class="nx">destroyAll</span><span class="p">()</span>
        
      <span class="nv">collection.authenticatedFind = </span><span class="nf">(user, id) -&gt;</span>
    
        <span class="nx">validateUser</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nf">-&gt;</span>
          <span class="nx">orm</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="nx">identity</span><span class="p">).</span><span class="nx">find</span> <span class="nx">id</span>
      
        <span class="p">).</span><span class="nx">then</span> <span class="nf">(model) -&gt;</span>
          <span class="k">return</span> <span class="nx">model</span> <span class="k">if</span> <span class="nx">model</span><span class="o">?</span> <span class="o">and</span> <span class="nx">model</span><span class="p">.</span><span class="nx">isAccessibleBy</span> <span class="nx">user</span>
          
          <span class="nv">error = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Resource not found.&quot;</span>
          <span class="nv">error.code = </span><span class="mi">404</span>
          <span class="nx">Promise</span><span class="p">.</span><span class="nx">reject</span> <span class="nx">error</span>
      
      <span class="nv">collection.authenticatedUpdate = </span><span class="nf">(user, id, attributes) -&gt;</span>
    
        <span class="nx">validateUser</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nf">-&gt;</span>
          <span class="nx">collection</span><span class="p">.</span><span class="nx">authenticatedFind</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">id</span>
        
        <span class="p">).</span><span class="nx">then</span> <span class="nf">(model) -&gt;</span>
          <span class="k">if</span> <span class="nx">model</span><span class="p">.</span><span class="nx">isEditableBy</span> <span class="nx">user</span>
            <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">attributes</span>
              <span class="nx">model</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>
            <span class="nv">model.id = </span><span class="nx">id</span>
            <span class="k">return</span> <span class="nx">model</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
            
          <span class="k">if</span> <span class="nx">model</span><span class="p">.</span><span class="nx">isAccessibleBy</span> <span class="nx">user</span>
            <span class="nv">error = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Access denied.&quot;</span>
            <span class="nv">error.code = </span><span class="mi">403</span>
          <span class="k">else</span>
            <span class="nv">error = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Resource not found.&quot;</span>
            <span class="nv">error.code = </span><span class="mi">404</span>
          
          <span class="nx">Promise</span><span class="p">.</span><span class="nx">reject</span> <span class="nx">error</span>
        
      <span class="nx">collection</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">isAccessibleBy</span> <span class="o">?=</span> <span class="nf">(user) -&gt;</span> <span class="kc">false</span>
      <span class="nx">collection</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">isEditableBy</span> <span class="o">?=</span> <span class="nf">(user) -&gt;</span> <span class="kc">false</span>
      <span class="nx">collection</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">isDeletableBy</span> <span class="o">?=</span> <span class="nf">(user) -&gt;</span> <span class="kc">false</span>
      
  <span class="k">return</span></div></div></div></div></body></html>