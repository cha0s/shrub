<!DOCTYPE html><html lang="en"><head><title>client/modules/packages/user/index</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../../"><meta name="groc-document-path" content="client/modules/packages/user/index"><meta name="groc-project-path" content="client/modules/packages/user/index.coffee"><meta name="groc-github-url" content="https://github.com/cha0s/shrub"><link rel="stylesheet" type="text/css" media="all" href="../../../../assets/style.css"><script type="text/javascript" src="../../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/cha0s/shrub/blob/master/client/modules/packages/user/index.coffee">client/modules/packages/user/index.coffee</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="nv">Promise = </span><span class="nx">require</span> <span class="s1">&#39;bluebird&#39;</span>

<span class="nx">exports</span><span class="p">.</span><span class="nv">$models = </span><span class="nf">(schema) -&gt;</span>
  
  <span class="nv">User = </span><span class="nx">schema</span><span class="p">.</span><span class="nx">define</span> <span class="s1">&#39;User&#39;</span><span class="p">,</span>
    
    <span class="nv">email:</span>
      <span class="nv">type: </span><span class="nb">String</span>
      <span class="nv">index: </span><span class="kc">true</span>
    
    <span class="nv">iname:</span>
      <span class="nv">type: </span><span class="nb">String</span>
      <span class="nv">length: </span><span class="mi">24</span>
      <span class="nv">index: </span><span class="kc">true</span>
      
    <span class="nv">name:</span>
      <span class="nv">type: </span><span class="nb">String</span>
      <span class="nv">default: </span><span class="s1">&#39;Anonymous&#39;</span>
      <span class="nv">length: </span><span class="mi">24</span>
      
    <span class="nv">passwordHash:</span>
      <span class="nv">type: </span><span class="nb">String</span>
    
    <span class="nv">resetPasswordToken:</span>
      <span class="nv">type: </span><span class="nb">String</span>
      <span class="nv">length: </span><span class="mi">48</span>
      <span class="nv">index: </span><span class="kc">true</span>
    
    <span class="nv">salt:</span>
      <span class="nv">type: </span><span class="nb">String</span>
      <span class="nv">length: </span><span class="mi">128</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Temporary... secure by default.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">User::hasPermission = </span><span class="nf">(perm) -&gt;</span> <span class="kc">false</span>
  <span class="nv">User::isAccessibleBy = </span><span class="nf">(user) -&gt;</span> <span class="kc">false</span>
  
  <span class="nv">User::redactFor = </span><span class="nf">(user) -&gt;</span>
    
    <span class="nv">redacted =</span>
      <span class="nv">name: </span><span class="nx">@name</span>
      <span class="nv">id: </span><span class="nx">@id</span>
      <span class="nv">email: </span><span class="nx">@email</span>
    
    <span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">redacted</span>

<span class="nv">augmentModel = </span><span class="nf">(User, Model, name) -&gt;</span>
  
  <span class="nv">validateUser = </span><span class="nf">(user) -&gt;</span>
    
    <span class="k">new</span> <span class="nx">Promise</span> <span class="nf">(resolve, reject) -&gt;</span>
    
      <span class="k">return</span> <span class="nx">resolve</span><span class="p">()</span> <span class="k">if</span> <span class="nx">user</span> <span class="k">instanceof</span> <span class="nx">User</span>
        
      <span class="nv">error = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;Invalid user.&quot;</span>
      <span class="nv">error.code = </span><span class="mi">500</span>
      <span class="nx">reject</span> <span class="nx">error</span>
  
  <span class="nv">checkPermission = </span><span class="nf">(user, perm) -&gt;</span>
  
    <span class="k">new</span> <span class="nx">Promise</span> <span class="nf">(resolve, reject) -&gt;</span>

      <span class="k">return</span> <span class="nx">resolve</span><span class="p">()</span> <span class="k">if</span> <span class="nx">user</span><span class="p">.</span><span class="nx">hasPermission</span> <span class="nx">perm</span>
        
      <span class="nv">error = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;Access denied.&quot;</span>
      <span class="nv">error.code = </span><span class="mi">403</span>
      <span class="nx">reject</span> <span class="nx">error</span>
      
  <span class="nv">Model.authenticatedAll = </span><span class="nf">(user, params) -&gt;</span>
    
    <span class="nx">validateUser</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="k">then</span><span class="p">(</span><span class="o">-&gt;</span>

      <span class="nx">checkPermission</span> <span class="nx">user</span><span class="p">,</span> <span class="s2">&quot;schema:#{name}:all&quot;</span>
    
    <span class="p">).</span><span class="k">then</span><span class="p">(</span><span class="o">-&gt;</span>
      
      <span class="nx">Model</span><span class="p">.</span><span class="nx">all</span> <span class="nx">params</span>
    
    <span class="p">).</span><span class="k">then</span><span class="p">(</span><span class="nf">(models) -&gt;</span>
      
      <span class="nx">models</span><span class="p">.</span><span class="nx">filter</span> <span class="nf">(model) -&gt;</span> <span class="nx">model</span><span class="p">.</span><span class="nx">isAccessibleBy</span> <span class="nx">user</span>
    
    <span class="p">).</span><span class="k">then</span><span class="p">(</span><span class="nf">(models) -&gt;</span>
      
      <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span> <span class="nx">models</span><span class="p">.</span><span class="nx">map</span> <span class="nf">(model) -&gt;</span> <span class="nx">model</span><span class="p">.</span><span class="nx">redactFor</span> <span class="nx">user</span>
    
    <span class="p">).</span><span class="k">then</span> <span class="nf">(models) -&gt;</span>
      
      <span class="k">return</span> <span class="nx">models</span> <span class="k">if</span> <span class="nx">models</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      
      <span class="nv">error = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;Collection not found.&quot;</span>
      <span class="nv">error.code = </span><span class="mi">404</span>
      <span class="nx">Promise</span><span class="p">.</span><span class="nx">reject</span> <span class="nx">error</span>
  
  <span class="nv">Model.authenticatedCount = </span><span class="nf">(user) -&gt;</span>
    
    <span class="nx">validateUser</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="k">then</span><span class="p">(</span><span class="o">-&gt;</span>
      
      <span class="nx">checkPermission</span> <span class="nx">user</span><span class="p">,</span> <span class="s2">&quot;schema:#{name}:count&quot;</span>
    
    <span class="p">).</span><span class="k">then</span> <span class="o">-&gt;</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span>
    
  <span class="nv">Model.authenticatedCreate = </span><span class="nf">(user, properties) -&gt;</span>

    <span class="nx">validateUser</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="k">then</span><span class="p">(</span><span class="o">-&gt;</span>
      
      <span class="nx">checkPermission</span> <span class="nx">user</span><span class="p">,</span> <span class="s2">&quot;schema:#{name}:create&quot;</span>
    
    <span class="p">).</span><span class="k">then</span> <span class="o">-&gt;</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">create</span> <span class="nx">properties</span>

  <span class="nv">Model.authenticatedDestroy = </span><span class="nf">(user, id) -&gt;</span>
  
    <span class="nx">validateUser</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="k">then</span><span class="p">(</span><span class="o">-&gt;</span>
      
      <span class="nx">checkPermission</span> <span class="nx">user</span><span class="p">,</span> <span class="s2">&quot;schema:#{name}:create&quot;</span>
    
    <span class="p">).</span><span class="k">then</span><span class="p">(</span><span class="o">-&gt;</span>
      
      <span class="nx">Model</span><span class="p">.</span><span class="nx">authenticatedFind</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">id</span>
    
    <span class="p">).</span><span class="k">then</span> <span class="nf">(model) -&gt;</span>
    
      <span class="k">return</span> <span class="nx">model</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span> <span class="k">if</span> <span class="nx">model</span><span class="p">.</span><span class="nx">isDeletableBy</span> <span class="nx">user</span>
        
      <span class="k">if</span> <span class="nx">model</span><span class="p">.</span><span class="nx">isAccessibleBy</span> <span class="nx">user</span>
        <span class="nv">error = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;Access denied.&quot;</span>
        <span class="nv">error.code = </span><span class="mi">403</span>
      <span class="k">else</span>
        <span class="nv">error = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;Resource not found.&quot;</span>
        <span class="nv">error.code = </span><span class="mi">404</span>
      
      <span class="nx">Promise</span><span class="p">.</span><span class="nx">reject</span> <span class="nx">error</span>
  
  <span class="nv">Model.authenticatedDestroyAll = </span><span class="nf">(user) -&gt;</span>
  
    <span class="nx">validateUser</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="k">then</span><span class="p">(</span><span class="o">-&gt;</span>
      
      <span class="nx">checkPermission</span> <span class="s2">&quot;schema:#{name}:destroyAll&quot;</span>
    
    <span class="p">).</span><span class="k">then</span> <span class="o">-&gt;</span>
      
      <span class="nx">Model</span><span class="p">.</span><span class="nx">destroyAll</span><span class="p">()</span>
    
  <span class="nv">Model.authenticatedFind = </span><span class="nf">(user, id) -&gt;</span>

    <span class="nx">validateUser</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="k">then</span><span class="p">(</span><span class="o">-&gt;</span>
      
      <span class="nx">Model</span><span class="p">.</span><span class="nx">find</span> <span class="nx">id</span>
  
    <span class="p">).</span><span class="k">then</span> <span class="nf">(model) -&gt;</span>
      
      <span class="k">if</span> <span class="nx">model</span><span class="o">?</span> <span class="o">and</span> <span class="nx">model</span><span class="p">.</span><span class="nx">isAccessibleBy</span> <span class="nx">user</span>
        <span class="k">return</span> <span class="nx">model</span><span class="p">.</span><span class="nx">redactFor</span> <span class="nx">user</span>
      
      <span class="nv">error = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;Resource not found.&quot;</span>
      <span class="nv">error.code = </span><span class="mi">404</span>
      <span class="nx">Promise</span><span class="p">.</span><span class="nx">reject</span> <span class="nx">error</span>
  
  <span class="nv">Model.authenticatedUpdate = </span><span class="nf">(user, id, properties) -&gt;</span>

    <span class="nx">validateUser</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="k">then</span><span class="p">(</span><span class="o">-&gt;</span>
      
      <span class="nx">Model</span><span class="p">.</span><span class="nx">authenticatedFind</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">id</span>
    
    <span class="p">).</span><span class="k">then</span> <span class="nf">(model) -&gt;</span>
      
      <span class="k">if</span> <span class="nx">model</span><span class="p">.</span><span class="nx">isEditableBy</span> <span class="nx">user</span>
        <span class="k">return</span> <span class="nx">model</span><span class="p">.</span><span class="nx">updateAttributes</span> <span class="nx">properties</span>
        
      <span class="k">if</span> <span class="nx">model</span><span class="p">.</span><span class="nx">isAccessibleBy</span> <span class="nx">user</span>
        <span class="nv">error = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;Access denied.&quot;</span>
        <span class="nv">error.code = </span><span class="mi">403</span>
      <span class="k">else</span>
        <span class="nv">error = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;Resource not found.&quot;</span>
        <span class="nv">error.code = </span><span class="mi">404</span>
      
      <span class="nx">Promise</span><span class="p">.</span><span class="nx">reject</span> <span class="nx">error</span>
    
  <span class="nx">Model</span><span class="o">::</span><span class="nx">isAccessibleBy</span> <span class="o">?=</span> <span class="nf">(user) -&gt;</span> <span class="kc">true</span>
  <span class="nx">Model</span><span class="o">::</span><span class="nx">isEditableBy</span> <span class="o">?=</span> <span class="nf">(user) -&gt;</span> <span class="kc">false</span>
  <span class="nx">Model</span><span class="o">::</span><span class="nx">isDeletableBy</span> <span class="o">?=</span> <span class="nf">(user) -&gt;</span> <span class="kc">false</span>
  <span class="nx">Model</span><span class="o">::</span><span class="nx">redactFor</span> <span class="o">?=</span> <span class="nf">(user) -&gt;</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span> <span class="k">this</span>

<span class="nx">exports</span><span class="p">.</span><span class="nv">$modelsAlter = </span><span class="nf">(models) -&gt;</span>
  
  <span class="nx">augmentModel</span> <span class="nx">models</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="nx">Model</span><span class="p">,</span> <span class="nx">name</span> <span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">Model</span> <span class="k">of</span> <span class="nx">models</span>
    
<span class="nx">exports</span><span class="p">.</span><span class="nv">$service = </span><span class="o">-&gt;</span> <span class="p">[</span>
  <span class="s1">&#39;$q&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="s1">&#39;rpc&#39;</span><span class="p">,</span> <span class="s1">&#39;schema&#39;</span><span class="p">,</span> <span class="s1">&#39;socket&#39;</span>
  <span class="nf">($q, config, rpc, schema, socket) -&gt;</span>
    
    <span class="nv">service = </span><span class="p">{}</span>
    
    <span class="nv">user = </span><span class="k">new</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">User</span>
    
    <span class="nv">logout = </span><span class="o">-&gt;</span> <span class="nx">user</span><span class="p">.</span><span class="nx">fromObject</span> <span class="p">(</span><span class="k">new</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">User</span><span class="p">).</span><span class="nx">toObject</span><span class="p">()</span>
    
    <span class="nx">socket</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;user.logout&#39;</span><span class="p">,</span> <span class="nx">logout</span>
    
    <span class="nv">service.isLoggedIn = </span><span class="o">-&gt;</span> <span class="nx">service</span><span class="p">.</span><span class="nx">instance</span><span class="p">().</span><span class="nx">id</span><span class="o">?</span> 
      
    <span class="nv">service.login = </span><span class="nf">(method, username, password) -&gt;</span>
      
      <span class="nx">rpc</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span>
        <span class="s1">&#39;user.login&#39;</span>
        <span class="nv">method: </span><span class="nx">method</span>
        <span class="nv">username: </span><span class="nx">username</span>
        <span class="nv">password: </span><span class="nx">password</span>
      
      <span class="p">).</span><span class="k">then</span> <span class="nf">(O) -&gt;</span>
        <span class="nx">user</span><span class="p">.</span><span class="nx">fromObject</span> <span class="nx">O</span>
        <span class="nx">user</span>

    <span class="nv">service.logout = </span><span class="o">-&gt;</span>
      
      <span class="nx">rpc</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span>
        <span class="s1">&#39;user.logout&#39;</span>

      <span class="p">).</span><span class="k">then</span> <span class="nx">logout</span>
    
    <span class="nv">isLoaded = </span><span class="kc">false</span>
    <span class="nv">service.instance = </span><span class="o">-&gt;</span>
      
      <span class="nx">unless</span> <span class="nx">isLoaded</span>
        <span class="nv">isLoaded = </span><span class="kc">true</span>
        <span class="nx">user</span><span class="p">.</span><span class="nx">fromObject</span> <span class="nx">config</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;user&#39;</span>
      
      <span class="nx">user</span>
    
    <span class="nx">service</span>
    
<span class="p">]</span>

<span class="nx">exports</span><span class="p">.</span><span class="nv">$serviceMock = </span><span class="o">-&gt;</span> <span class="p">[</span>
  <span class="s1">&#39;$delegate&#39;</span><span class="p">,</span> <span class="s1">&#39;socket&#39;</span>
  <span class="nf">($delegate, socket) -&gt;</span>
    
    <span class="nv">$delegate.fakeLogin = </span><span class="nf">(username, password = &#39;password&#39;, id = 1) -&gt;</span>
  
      <span class="nx">socket</span><span class="p">.</span><span class="nx">catchEmit</span> <span class="s1">&#39;rpc://user.login&#39;</span><span class="p">,</span> <span class="nf">(data, fn) -&gt;</span>
        <span class="nx">fn</span> <span class="nv">result: id: </span><span class="nx">id</span><span class="p">,</span> <span class="nv">name: </span><span class="nx">username</span>
        
      <span class="nx">$delegate</span><span class="p">.</span><span class="nx">login</span> <span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">password</span>
      
    <span class="nx">$delegate</span>
  
<span class="p">]</span>

<span class="nx">exports</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">require</span> <span class="s2">&quot;./#{path}&quot;</span> <span class="k">for</span> <span class="nx">path</span> <span class="k">in</span> <span class="p">[</span>
  <span class="s1">&#39;forgot&#39;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="s1">&#39;logout&#39;</span><span class="p">,</span> <span class="s1">&#39;register&#39;</span><span class="p">,</span> <span class="s1">&#39;reset&#39;</span>
<span class="p">]</span></div></div></div></div></body></html>